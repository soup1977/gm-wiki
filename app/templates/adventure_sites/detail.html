{% extends "base.html" %}
{% block title %}{{ site.name }} — The War Table{% endblock %}

{% block content %}
<div id="efs-context" data-site-id="{{ site.id }}" data-mode="detail" class="d-none"></div>

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('adventure_sites.list_sites') }}">Adventure Sites</a></li>
        <li class="breadcrumb-item active">{{ site.name }}</li>
    </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-start mb-1 flex-wrap gap-2">
    <div>
        <h2 class="mb-0">
            {{ site.name }}
            <span class="status-badge ms-2 align-middle fs-6" data-status="{{ site.status }}">{{ site.status }}</span>
        </h2>
        {% if site.subtitle %}
        <p class="text-muted fst-italic mt-1 mb-0">{{ site.subtitle }}</p>
        {% endif %}
    </div>
    <div class="d-flex gap-2 flex-shrink-0 align-items-center">
        {% if site.is_player_visible %}
        <span class="badge bg-info"><i class="bi bi-people-fill"></i> Player Visible</span>
        {% else %}
        <span class="badge bg-secondary"><i class="bi bi-eye-slash"></i> Hidden</span>
        {% endif %}
        <a href="{{ url_for('sessions.create_session') }}?site_id={{ site.id }}" class="btn btn-outline-success btn-sm">
            <i class="bi bi-play-circle"></i> Start Session Here
        </a>
        <a href="{{ url_for('adventure_sites.edit_site', site_id=site.id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <form method="POST" action="{{ url_for('adventure_sites.delete_site', site_id=site.id) }}"
              onsubmit="return confirm('Delete {{ site.name }}? This cannot be undone.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

{% if site.tags %}
<div class="mb-3">
    {% for tag in site.tags %}
    <span class="badge bg-secondary me-1">{{ tag.name }}</span>
    {% endfor %}
</div>
{% endif %}

<hr class="border-secondary mb-4">

<!-- Two-column layout: content left, sidebar right -->
<div class="row g-4">

    <!-- MAIN CONTENT (rendered Markdown) -->
    <div class="col-md-8 col-lg-9">
        {% if site.content %}
        <div id="site-content" class="markdown-body">
            {{ site.content | md | safe }}
        </div>
        {% else %}
        <p class="text-muted fst-italic">No content yet. <a href="{{ url_for('adventure_sites.edit_site', site_id=site.id) }}">Add some.</a></p>
        {% endif %}
    </div>

    <!-- SIDEBAR: Navigation (ToC) + Run State + Linked Sessions -->
    <div class="col-md-4 col-lg-3">
        <div class="sticky-top" style="top: 80px; max-height: calc(100vh - 100px); overflow-y: auto;">

            <!-- Navigation card (ToC generated by JS) -->
            <div class="card bg-dark border-secondary mb-3" id="toc-card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span class="small fw-bold text-muted text-uppercase">Navigation</span>
                </div>
                <div class="card-body py-2 px-2">
                    <nav id="site-toc">
                        <p class="text-muted small mb-0 px-2">No headings found.</p>
                    </nav>
                </div>
            </div>

            <!-- Run State card (client-side state tracking) -->
            <div class="card bg-dark border-secondary mb-3" id="run-state-card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span class="small fw-bold text-muted text-uppercase">
                        <i class="bi bi-play-fill text-success"></i> Run State
                    </span>
                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" id="reset-state-btn" title="Reset all state">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </div>
                <div class="card-body py-2 px-3">
                    <!-- Generic counter -->
                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" id="counter-dec">−</button>
                            <input type="number" class="form-control text-center" id="counter-val" value="0" min="0">
                            <button class="btn btn-outline-secondary" id="counter-inc">+</button>
                        </div>
                        <input type="text" class="form-control form-control-sm mt-1" id="counter-label"
                               placeholder="Counter label (e.g. Timer, Rounds)">
                    </div>
                    <!-- Section checkboxes (generated by JS) -->
                    <div id="section-checks">
                        <p class="text-muted small mb-0">Section checkboxes appear here.</p>
                    </div>
                </div>
            </div>

            <!-- Linked Sessions -->
            {% if site.sessions or site.estimated_sessions %}
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header py-2">
                    <span class="small fw-bold text-muted text-uppercase">Sessions</span>
                </div>
                <div class="card-body py-2 px-3">
                    {% if site.estimated_sessions %}
                    <p class="small text-muted mb-2">Planned: ~{{ site.estimated_sessions }} session{{ 's' if site.estimated_sessions != 1 }}</p>
                    {% endif %}
                    {% if site.sessions %}
                    <ul class="list-unstyled mb-0">
                        {% for sess in site.sessions | sort(attribute='number') %}
                        <li class="mb-1">
                            <a href="{{ url_for('sessions.session_detail', session_id=sess.id) }}" class="text-decoration-none small">
                                <i class="bi bi-play-circle text-muted"></i>
                                {% if sess.number %}Session {{ sess.number }}{% endif %}
                                {% if sess.title %} — {{ sess.title }}{% endif %}
                            </a>
                            {% if sess.date_played %}
                            <br><span class="text-muted" style="font-size: 0.75rem; margin-left: 1.2rem;">{{ sess.date_played }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted small mb-0">No sessions linked yet.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- DB-backed Milestones card -->
            {% set milestone_list = site.get_milestones() %}
            {% if milestone_list %}
            <div class="card bg-dark border-secondary mb-3" id="milestones-card">
                <div class="card-header py-2">
                    <span class="small fw-bold text-muted text-uppercase">
                        <i class="bi bi-flag-fill text-warning"></i> Milestones
                    </span>
                </div>
                <div class="card-body py-2 px-3">
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-success" id="milestone-progress" role="progressbar"
                             style="width: {{ site.progress_pct }}%"
                             aria-valuenow="{{ site.progress_pct }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <p class="text-muted small mb-2" id="milestone-summary">
                        {{ milestone_list | selectattr('done') | list | length }} / {{ milestone_list | length }} complete
                    </p>
                    <div id="milestone-checks">
                        {% for m in milestone_list %}
                        <div class="form-check mb-1">
                            <input type="checkbox" class="form-check-input milestone-cb"
                                   id="ms-{{ loop.index0 }}" data-index="{{ loop.index0 }}"
                                   {% if m.done %}checked{% endif %}>
                            <label class="form-check-label small {% if m.done %}text-decoration-line-through text-muted{% endif %}"
                                   for="ms-{{ loop.index0 }}">{{ m.label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if ai_enabled %}
            <!-- AI Milestone Suggestions card -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span class="small fw-bold text-muted text-uppercase">
                        <i class="bi bi-check2-square me-1"></i> Milestones
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-info py-0 px-2"
                            id="suggest-milestones-btn" onclick="suggestMilestones()">
                        <i class="bi bi-stars"></i> Suggest
                    </button>
                </div>
                <div class="card-body py-2 px-3 d-none" id="milestones-result">
                    <div id="milestones-content" class="small text-light"></div>
                </div>
            </div>
            {% endif %}

        </div><!-- sticky-top -->
    </div><!-- sidebar col -->

</div><!-- row -->

{% if linked_entities %}
<div class="mt-4 border-top border-secondary pt-3">
    <h6 class="text-muted small"><i class="bi bi-box-arrow-up-right me-1"></i>Linked Entities</h6>
    <div class="d-flex flex-wrap gap-2">
        {% for e in linked_entities %}
        <a href="{{ e.url }}" class="btn btn-sm btn-outline-light">
            {% if e.type == 'npc' %}<i class="bi bi-person"></i>
            {% elif e.type == 'loc' %}<i class="bi bi-geo-alt"></i>
            {% elif e.type == 'quest' %}<i class="bi bi-flag"></i>
            {% elif e.type == 'item' %}<i class="bi bi-backpack"></i>
            {% elif e.type == 'comp' %}<i class="bi bi-journal-text"></i>
            {% elif e.type == 'pc' %}<i class="bi bi-person-badge"></i>
            {% else %}<i class="bi bi-link-45deg"></i>
            {% endif %}
            {{ e.label }}
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if mentions %}
<div class="mt-4 border-top border-secondary pt-3">
    <h6 class="text-muted small"><i class="bi bi-link-45deg me-1"></i>Referenced by</h6>
    <div class="d-flex flex-wrap gap-2">
        {% for m in mentions %}
        <a href="{{ m.url }}" class="badge bg-secondary text-decoration-none">{{ m.label }}</a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- JS: ToC generation + Run State persistence -->
<script>
(function() {
    const SITE_ID = {{ site.id }};
    const STATE_KEY = 'site_state_' + SITE_ID;

    // ── ToC generation ──────────────────────────────────────────────────────
    const content = document.getElementById('site-content');
    const toc = document.getElementById('site-toc');
    const sectionChecks = document.getElementById('section-checks');

    if (content) {
        const headings = content.querySelectorAll('h2, h3');
        if (headings.length > 0) {
            toc.innerHTML = '';
            sectionChecks.innerHTML = '';

            headings.forEach(function(h, i) {
                // Add anchor id to the heading
                const slug = h.textContent.trim()
                    .toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-');
                const id = slug + '-' + i;
                h.id = id;

                // ToC link
                const a = document.createElement('a');
                a.href = '#' + id;
                a.textContent = h.textContent;
                a.className = 'toc-link d-block text-decoration-none py-1 px-2 rounded small '
                    + (h.tagName === 'H3' ? 'ms-2 text-muted' : 'text-light');
                a.dataset.target = id;
                toc.appendChild(a);

                // Section checkbox (only H2 headings)
                if (h.tagName === 'H2') {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-1';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'form-check-input';
                    cb.id = 'check-' + id;
                    cb.dataset.section = id;
                    const lbl = document.createElement('label');
                    lbl.className = 'form-check-label small';
                    lbl.htmlFor = 'check-' + id;
                    lbl.textContent = h.textContent;
                    div.appendChild(cb);
                    div.appendChild(lbl);
                    sectionChecks.appendChild(div);
                    cb.addEventListener('change', saveState);
                }
            });

            // IntersectionObserver: highlight current section in ToC
            const tocLinks = toc.querySelectorAll('.toc-link');
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        tocLinks.forEach(function(l) { l.classList.remove('active', 'bg-primary'); });
                        const active = toc.querySelector('[data-target="' + entry.target.id + '"]');
                        if (active) { active.classList.add('active', 'bg-primary'); }
                    }
                });
            }, { rootMargin: '0px 0px -60% 0px', threshold: 0 });

            headings.forEach(function(h) { observer.observe(h); });
        }
    }

    // ── Run State persistence ────────────────────────────────────────────────
    const counterVal = document.getElementById('counter-val');
    const counterLabel = document.getElementById('counter-label');
    const counterDec = document.getElementById('counter-dec');
    const counterInc = document.getElementById('counter-inc');
    const resetBtn = document.getElementById('reset-state-btn');

    function loadState() {
        try {
            const raw = localStorage.getItem(STATE_KEY);
            if (!raw) return;
            const s = JSON.parse(raw);
            if (s.counter !== undefined) counterVal.value = s.counter;
            if (s.label !== undefined) counterLabel.value = s.label;
            if (s.checks) {
                Object.keys(s.checks).forEach(function(id) {
                    const cb = document.querySelector('[data-section="' + id + '"]');
                    if (cb) cb.checked = s.checks[id];
                });
            }
        } catch(e) {}
    }

    function saveState() {
        const checks = {};
        document.querySelectorAll('[data-section]').forEach(function(cb) {
            checks[cb.dataset.section] = cb.checked;
        });
        localStorage.setItem(STATE_KEY, JSON.stringify({
            counter: parseInt(counterVal.value) || 0,
            label: counterLabel.value,
            checks: checks
        }));
    }

    counterDec.addEventListener('click', function() {
        const v = parseInt(counterVal.value) || 0;
        counterVal.value = Math.max(0, v - 1);
        saveState();
    });
    counterInc.addEventListener('click', function() {
        const v = parseInt(counterVal.value) || 0;
        counterVal.value = v + 1;
        saveState();
    });
    counterVal.addEventListener('change', saveState);
    counterLabel.addEventListener('input', saveState);

    resetBtn.addEventListener('click', function() {
        if (!confirm('Reset all run state for this site?')) return;
        localStorage.removeItem(STATE_KEY);
        counterVal.value = 0;
        counterLabel.value = '';
        document.querySelectorAll('[data-section]').forEach(function(cb) {
            cb.checked = false;
        });
    });

    // Load saved state after a short delay to let JS build the checkboxes first
    loadState();

    // ── DB-backed Milestones ──────────────────────────────────────────────────
    var milestoneCbs = document.querySelectorAll('.milestone-cb');
    if (milestoneCbs.length > 0) {
        milestoneCbs.forEach(function(cb) {
            cb.addEventListener('change', function() {
                var lbl = document.querySelector('label[for="' + cb.id + '"]');
                if (cb.checked) {
                    lbl.classList.add('text-decoration-line-through', 'text-muted');
                } else {
                    lbl.classList.remove('text-decoration-line-through', 'text-muted');
                }
                saveMilestones();
            });
        });
    }

    function saveMilestones() {
        var milestones = [];
        document.querySelectorAll('.milestone-cb').forEach(function(cb) {
            var lbl = document.querySelector('label[for="' + cb.id + '"]');
            milestones.push({ label: lbl.textContent.trim(), done: cb.checked });
        });

        fetch('/sites/' + SITE_ID + '/update-milestones', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ milestones: milestones })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var bar = document.getElementById('milestone-progress');
                if (bar) {
                    bar.style.width = data.progress_pct + '%';
                    bar.setAttribute('aria-valuenow', data.progress_pct);
                }
                var done = milestones.filter(function(m) { return m.done; }).length;
                var summary = document.getElementById('milestone-summary');
                if (summary) {
                    summary.textContent = done + ' / ' + milestones.length + ' complete';
                }
            }
        })
        .catch(function() {}); // silently ignore failures
    }
})();
</script>

<style>
.toc-link { transition: background 0.15s; }
.toc-link:hover { background: rgba(255,255,255,0.07); }
#site-content h2, #site-content h3 { scroll-margin-top: 80px; }
</style>

{% if ai_enabled %}
<input type="hidden" id="site-csrf" value="{{ csrf_token() }}">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function suggestMilestones() {
    const btn     = document.getElementById('suggest-milestones-btn');
    const result  = document.getElementById('milestones-result');
    const content = document.getElementById('milestones-content');
    const _csrf   = document.getElementById('site-csrf').value;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    result.classList.add('d-none');

    fetch('/sites/{{ site.id }}/suggest-milestones', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': _csrf },
        body: '{}'
    })
    .then(function (r) { return r.json(); })
    .then(function (data) {
        if (data.error) { throw new Error(data.error); }
        content.innerHTML = marked.parse(data.milestones);
        result.classList.remove('d-none');
    })
    .catch(function (err) {
        content.innerHTML = '<span class="text-danger">' + err.message + '</span>';
        result.classList.remove('d-none');
    })
    .finally(function () {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Suggest';
    });
}
</script>
{% endif %}
{% endblock %}
