{% extends "base.html" %}
{% block title %}New Campaign — The War Table{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="mb-4">New Campaign</h2>
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="name" class="form-label">Campaign Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" required autofocus>
            </div>
            <div class="mb-3">
                <label for="system" class="form-label">System</label>
                <input type="text" class="form-control" id="system" name="system" placeholder="e.g. D&D 5e, ICRPG, Pathfinder…">
            </div>
            <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="active">Active</option>
                    <option value="on hiatus">On Hiatus</option>
                    <option value="complete">Complete</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            {% if ai_enabled %}
            <div class="mb-4">
                <label for="ai_world_context" class="form-label">AI World Context</label>
                <textarea class="form-control" id="ai_world_context" name="ai_world_context" rows="3"
                          placeholder="e.g. This campaign is set in a plague-ravaged Victorian city. Magic is rare and feared. The tone is grim and desperate."></textarea>
                <div class="form-text">Injected into AI-generated entries (NPCs, items, locations, etc.) so they match your campaign's setting and tone.</div>
            </div>
            {% endif %}

            {% if sd_enabled %}
            <div class="mb-4">
                <label for="image_style_prompt" class="form-label">Image Style Prompt</label>
                <textarea class="form-control" id="image_style_prompt" name="image_style_prompt" rows="2"
                          placeholder="e.g. dark fantasy oil painting, dramatic lighting, medieval"></textarea>
                <div class="form-text">Prepended to all AI-generated images for this campaign. Sets the visual tone for portraits, locations, and items.</div>
            </div>
            {% endif %}

            <hr class="border-secondary mb-4">

            <h5 class="mb-3">Player Character Stat Fields</h5>
            <p class="text-muted small mb-3">
                Choose a preset to auto-populate stat fields for your Player Characters.
                You can add, remove, or rename fields any time from Campaign Settings.
            </p>
            <div class="mb-3">
                <label for="stat_preset" class="form-label">Game System Preset</label>
                <select class="form-select" id="stat_preset" name="stat_preset" onchange="updatePresetPreview()">
                    {% for key, preset in stat_presets.items() %}
                    <option value="{{ key }}">{{ preset.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="preset-preview" class="mb-4" style="display:none;">
                <p class="text-muted small mb-2">Stat fields that will be created:</p>
                <ul id="preset-stat-list" class="list-group list-group-flush mb-0"></ul>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Create Campaign
                </button>
                <a href="{{ url_for('campaigns.list_campaigns') }}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Preset data mirrored from the server — keeps the preview client-side with no round trip.
const STAT_PRESETS = {{ stat_presets | tojson }};

function updatePresetPreview() {
    const key = document.getElementById('stat_preset').value;
    const preset = STAT_PRESETS[key];
    const preview = document.getElementById('preset-preview');
    const list = document.getElementById('preset-stat-list');

    list.innerHTML = '';
    if (preset && preset.stats.length > 0) {
        preset.stats.forEach(function(stat) {
            const li = document.createElement('li');
            li.className = 'list-group-item bg-dark text-light border-secondary py-1 small';
            li.textContent = stat;
            list.appendChild(li);
        });
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Show preview on page load for whichever option is selected by default
updatePresetPreview();
</script>
{% endblock %}
