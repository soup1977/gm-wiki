{% extends "base.html" %}
{% block title %}Campaign Assistant — The War Table{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-robot me-2"></i>Campaign Assistant</h2>
    {% if campaign %}
    <span class="text-muted small">{{ campaign.name }}</span>
    {% endif %}
</div>

{% if not ai_enabled %}
<div class="alert alert-warning d-flex align-items-center gap-2">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span>AI is not configured. <a href="{{ url_for('settings.index') }}">Go to Settings</a> to set up Anthropic or Ollama.</span>
</div>
{% endif %}

{% if not campaign %}
<div class="alert alert-info d-flex align-items-center gap-2">
    <i class="bi bi-info-circle-fill"></i>
    <span>No active campaign. <a href="{{ url_for('campaigns.list_campaigns') }}">Select a campaign</a> to get started.</span>
</div>
{% endif %}

<div class="row g-3">

    <!-- Left: Campaign context panel -->
    <div class="col-md-3">
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header text-muted small">
                <i class="bi bi-info-circle me-1"></i>Campaign Context
            </div>
            <div class="card-body small">
                {% if campaign %}
                <p class="fw-semibold mb-1">{{ campaign.name }}</p>
                {% if campaign.system %}
                <p class="text-muted mb-2">{{ campaign.system }}</p>
                {% endif %}
                {% if campaign.ai_world_context %}
                <p class="text-muted mb-2" style="font-size:0.8rem;">
                    {{ campaign.ai_world_context[:200] }}{% if campaign.ai_world_context|length > 200 %}…{% endif %}
                </p>
                {% endif %}
                <hr class="border-secondary my-2">
                <div class="text-muted" style="font-size:0.8rem;">
                    <div><i class="bi bi-person me-1"></i>{{ context.npc_count }} NPC{{ 's' if context.npc_count != 1 }}</div>
                    <div><i class="bi bi-geo-alt me-1"></i>{{ context.location_count }} Location{{ 's' if context.location_count != 1 }}</div>
                    <div><i class="bi bi-scroll me-1"></i>{{ context.quest_count }} Quest{{ 's' if context.quest_count != 1 }}</div>
                    <div><i class="bi bi-bag me-1"></i>{{ context.item_count }} Item{{ 's' if context.item_count != 1 }}</div>
                </div>
                {% else %}
                <p class="text-muted mb-0">No campaign active.</p>
                {% endif %}
            </div>
        </div>

        <!-- Tips card -->
        <div class="card bg-dark border-secondary">
            <div class="card-header text-muted small">
                <i class="bi bi-lightbulb me-1"></i>Tips
            </div>
            <div class="card-body small text-muted">
                <ul class="ps-3 mb-0">
                    <li class="mb-1">Ask for <strong>brainstorming</strong> ideas, plot hooks, or backstory</li>
                    <li class="mb-1">Say <strong>"create an NPC"</strong> to generate a saveable character</li>
                    <li class="mb-1">Say <strong>"create a location/quest/item"</strong> for other entity types</li>
                    <li class="mb-1">Ask <strong>follow-up questions</strong> — the assistant remembers the conversation</li>
                </ul>
                <hr class="border-secondary my-2">
                <button id="clear-chat-btn" class="btn btn-sm btn-outline-secondary w-100"
                        {% if not history %}disabled{% endif %}>
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Clear Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Right: Chat area -->
    <div class="col-md-9">
        <div class="card bg-dark border-secondary d-flex flex-column" style="height: 75vh;">

            <!-- Message history -->
            <div id="chat-messages" class="flex-grow-1 overflow-y-auto p-3" style="overflow-y: auto;">

                {% if not history %}
                <!-- Welcome message shown when no history -->
                <div class="text-center text-muted py-5">
                    <i class="bi bi-robot" style="font-size: 2.5rem;"></i>
                    <p class="mt-3 mb-1 fw-semibold">Campaign Assistant</p>
                    <p class="small">
                        {% if campaign %}
                        I know about <strong>{{ campaign.name }}</strong> and its content.<br>
                        Ask me anything — or say "create an NPC" to get started.
                        {% else %}
                        Select a campaign to get started.
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                <!-- Replay history (for page reload persistence) -->
                {% for msg in history %}
                {% if msg.role == 'user' %}
                <div class="d-flex justify-content-end mb-3">
                    <div class="bg-primary text-white rounded-3 px-3 py-2" style="max-width:75%; white-space:pre-wrap;">{{ msg.content }}</div>
                </div>
                {% else %}
                <div class="d-flex justify-content-start mb-3">
                    <div class="assistant-prose border border-secondary rounded-3 px-3 py-2"
                         style="max-width:85%;"
                         data-markdown={{ msg.content | tojson }}></div>
                </div>
                {% endif %}
                {% endfor %}

            </div>

            <!-- Input area -->
            <div class="border-top border-secondary p-3">
                <div class="input-group">
                    <textarea id="chat-input" class="form-control bg-dark border-secondary text-light"
                              rows="2" placeholder="Ask anything about your campaign…"
                              {% if not ai_enabled or not campaign %}disabled{% endif %}
                              style="resize: none;"></textarea>
                    <button id="chat-send-btn" class="btn btn-primary"
                            {% if not ai_enabled or not campaign %}disabled{% endif %}>
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div class="text-muted small mt-1">Press <kbd>Ctrl+Enter</kbd> to send</div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Markdown rendering inside assistant messages */
.assistant-prose p      { margin-bottom: 0.4rem; }
.assistant-prose p:last-child { margin-bottom: 0; }
.assistant-prose h1, .assistant-prose h2, .assistant-prose h3,
.assistant-prose h4, .assistant-prose h5 {
    font-size: 1rem;
    font-weight: 700;
    margin: 0.6rem 0 0.3rem;
}
.assistant-prose ul, .assistant-prose ol {
    padding-left: 1.4rem;
    margin-bottom: 0.4rem;
}
.assistant-prose li { margin-bottom: 0.15rem; }
.assistant-prose code {
    background: rgba(255,255,255,0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.85em;
}
.assistant-prose pre {
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 4px;
    padding: 0.6rem 0.8rem;
    overflow-x: auto;
    margin-bottom: 0.4rem;
}
.assistant-prose pre code { background: none; padding: 0; }
.assistant-prose hr  { border-color: rgba(255,255,255,0.2); margin: 0.5rem 0; }
.assistant-prose a   { color: #6ea8fe; }
.assistant-prose blockquote {
    border-left: 3px solid rgba(255,255,255,0.3);
    padding-left: 0.75rem;
    color: rgba(255,255,255,0.6);
    margin: 0.4rem 0;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Pass CSRF token and endpoints to the JS module
    window.ASSISTANT_CONFIG = {
        sendUrl:      '/api/ai/assistant',
        saveUrl:      '/api/ai/assistant/save-entity',
        clearUrl:     '/api/ai/assistant/clear',
        csrfToken:    '{{ csrf_token() }}',
        aiEnabled:    {{ 'true' if ai_enabled else 'false' }},
        hasCampaign:  {{ 'true' if campaign else 'false' }},
    };
</script>
<script src="{{ url_for('static', filename='js/campaign_assistant.js') }}"></script>
{% endblock %}
