{% extends "base.html" %}
{% block title %}{% if sess %}Edit Session{% else %}New Session{% endif %} — The War Table{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('sessions.list_sessions') }}">Sessions</a></li>
        {% if sess %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('sessions.session_detail', session_id=sess.id) }}">
                    {% if sess.number %}#{{ sess.number }}{% if sess.title %} — {{ sess.title }}{% endif %}{% else %}{{ sess.title or 'Untitled' }}{% endif %}
                </a>
            </li>
            <li class="breadcrumb-item active">Edit</li>
        {% else %}
            <li class="breadcrumb-item active">New</li>
        {% endif %}
    </ol>
</nav>

<div class="d-flex align-items-center gap-3 mb-4">
    <h2 class="mb-0">{% if sess %}Edit Session{% else %}New Session{% endif %}</h2>
    {% if ai_enabled %}
    <button type="button" class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal" data-bs-target="#smartFillModal">
        <i class="bi bi-stars"></i> Smart Fill
    </button>
    {% endif %}
</div>

{% if carryover %}
<div class="alert alert-info d-flex align-items-center gap-2 mb-3">
    <i class="bi bi-arrow-right-circle fs-5"></i>
    <div>
        <strong>Continuing from Session
            {% if carryover.from_session.number %}#{{ carryover.from_session.number }}{% endif %}
            {% if carryover.from_session.title %} — {{ carryover.from_session.title }}{% endif %}
        </strong>
        <br><span class="small">Active quests, alive NPCs, adventure site, and attending players carried over automatically.</span>
    </div>
</div>
{% endif %}

<form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-4">

        <!-- LEFT COLUMN: session metadata and relationships -->
        <div class="col-md-5">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body d-flex flex-column gap-3">

                    <!-- Session number, title, date -->
                    <div class="row g-2">
                        <div class="col-4">
                            <label for="number" class="form-label">Session #</label>
                            <input type="number" class="form-control" id="number" name="number" min="1"
                                   value="{{ sess.number if sess and sess.number else (carryover.next_number if carryover and carryover.next_number else '') }}">
                        </div>
                        <div class="col-8">
                            <label for="date_played" class="form-label">Date Played</label>
                            <input type="date" class="form-control" id="date_played" name="date_played"
                                   value="{{ sess.date_played.isoformat() if sess and sess.date_played else '' }}">
                        </div>
                    </div>

                    <div>
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title"
                               value="{{ sess.title if sess else '' }}"
                               placeholder="optional short title" autofocus>
                    </div>

                    <div>
                        <label for="tags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags"
                               value="{{ sess.tags | map(attribute='name') | join(', ') if sess else '' }}"
                               placeholder="e.g. combat-heavy, revelation, downtime">
                        <div class="form-text">Comma-separated.</div>
                    </div>

                    {% if all_sites %}
                    <div>
                        <label for="adventure_site_id" class="form-label">Adventure Site</label>
                        <select class="form-select" id="adventure_site_id" name="adventure_site_id">
                            <option value="">— None —</option>
                            {% for site in all_sites %}
                            <option value="{{ site.id }}"
                                {% if sess and sess.adventure_sites and site in sess.adventure_sites %}selected
                                {% elif carryover and carryover.site_id == site.id %}selected
                                {% elif preselect_site_id and preselect_site_id == site.id %}selected
                                {% endif %}>
                                {{ site.name }}{% if site.status %} ({{ site.status }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Which adventure site was this session run at?</div>
                    </div>
                    {% endif %}

                    <div>
                        <label for="npcs_featured" class="form-label">NPCs in This Session</label>
                        <div class="d-flex gap-2 align-items-start">
                            <select class="form-select flex-grow-1" id="npcs_featured" name="npcs_featured" multiple size="5">
                                {% for npc in npcs %}
                                <option value="{{ npc.id }}"
                                    {% if sess and npc in sess.npcs_featured %}selected
                                    {% elif carryover and npc.id in carryover.npc_ids %}selected
                                    {% endif %}>
                                    {{ npc.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-1 quick-create-btn"
                                    data-qc-entity="npc" data-qc-target="npcs_featured" data-qc-label="NPC">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="locations_visited" class="form-label">Locations Visited</label>
                        <div class="d-flex gap-2 align-items-start">
                            <select class="form-select flex-grow-1" id="locations_visited" name="locations_visited" multiple size="5">
                                {% for loc in locations %}
                                <option value="{{ loc.id }}"
                                    {% if sess and loc in sess.locations_visited %}selected{% endif %}>
                                    {{ loc.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-1 quick-create-btn"
                                    data-qc-entity="location" data-qc-target="locations_visited" data-qc-label="Location">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="quests_touched" class="form-label">Quests Touched</label>
                        <div class="d-flex gap-2 align-items-start">
                            <select class="form-select flex-grow-1" id="quests_touched" name="quests_touched" multiple size="5">
                                {% for quest in quests %}
                                <option value="{{ quest.id }}"
                                    {% if sess and quest in sess.quests_touched %}selected
                                    {% elif carryover and quest.id in carryover.quest_ids %}selected
                                    {% endif %}>
                                    {{ quest.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-1 quick-create-btn"
                                    data-qc-entity="quest" data-qc-target="quests_touched" data-qc-label="Quest">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="items_mentioned" class="form-label">Items Mentioned</label>
                        <div class="d-flex gap-2 align-items-start">
                            <select class="form-select flex-grow-1" id="items_mentioned" name="items_mentioned" multiple size="5">
                                {% for item in items %}
                                <option value="{{ item.id }}"
                                    {% if sess and item in sess.items_mentioned %}selected{% endif %}>
                                    {{ item.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-1 quick-create-btn"
                                    data-qc-entity="item" data-qc-target="items_mentioned" data-qc-label="Item">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    {% if monsters %}
                    <div>
                        <label for="monsters_encountered" class="form-label">Monsters Encountered</label>
                        <select class="form-select" id="monsters_encountered" name="monsters_encountered" multiple size="5">
                            {% for monster in monsters %}
                            <option value="{{ monster.id }}"
                                {% if sess and monster in sess.monsters_encountered %}selected{% endif %}>
                                {{ monster.instance_name }} ({{ monster.bestiary_entry.name }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="form-text">Hold Ctrl (Cmd on Mac) to select multiple in each list.</div>

                    {# Player Attendance #}
                    {% if pcs %}
                    <hr class="border-secondary my-1">
                    <div>
                        <label class="form-label fw-semibold">Player Attendance</label>
                        {% set attended_ids = sess.attending_pcs | map(attribute='id') | list if sess else [] %}
                        <div class="d-flex flex-column gap-1">
                            {% for pc in pcs %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="attended_pc_ids" value="{{ pc.id }}"
                                       id="pc_{{ pc.id }}"
                                       {% if pc.id in attended_ids %}checked
                                       {% elif carryover and pc.id in carryover.pc_ids %}checked
                                       {% endif %}>
                                <label class="form-check-label d-flex align-items-center gap-2" for="pc_{{ pc.id }}">
                                    {% if pc.portrait_filename %}
                                    <img src="{{ url_for('static', filename='uploads/' + pc.portrait_filename) }}"
                                         class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" alt="">
                                    {% endif %}
                                    <span>
                                        {{ pc.character_name }}
                                        <span class="text-muted small">({{ pc.player_name }})</span>
                                    </span>
                                    {% if pc.status != 'active' %}
                                    <span class="badge bg-secondary small">{{ pc.status }}</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="form-check">
                        <input type="checkbox" name="is_player_visible" id="is_player_visible"
                               class="form-check-input"
                               {% if sess and sess.is_player_visible %}checked{% endif %}>
                        <label class="form-check-label" for="is_player_visible">
                            <i class="bi bi-people"></i> Visible in Player Wiki
                        </label>
                    </div>

                </div><!-- card-body -->
            </div><!-- card -->
        </div><!-- col-md-5 -->

        <!-- RIGHT COLUMN: prep notes, summary, and GM notes -->
        <div class="col-md-7">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body d-flex flex-column gap-3">

                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <label for="prep_notes" class="form-label mb-0">
                                <i class="bi bi-journal-bookmark me-1 text-info"></i>Prep Notes
                            </label>
                            {% if ai_enabled %}
                            <button type="button" class="btn btn-outline-info btn-sm py-0 px-2" id="gen-prep-btn" onclick="generatePrepNotes()">
                                <i class="bi bi-stars"></i> Generate Prep
                            </button>
                            {% endif %}
                        </div>
                        <textarea class="form-control border-info" id="prep_notes" name="prep_notes" rows="6">{{ sess.prep_notes if sess and sess.prep_notes else '' }}</textarea>
                        <div class="form-text text-info">Planning notes for this session — shown in Session Mode during play. Markdown supported.</div>
                    </div>

                    <div>
                        <label for="summary" class="form-label">Summary <span class="text-muted small">(post-session)</span></label>
                        <textarea class="form-control" id="summary" name="summary" rows="10">{{ sess.summary if sess else '' }}</textarea>
                        <div class="form-text">What happened this session? Markdown supported.</div>
                    </div>

                    <div>
                        <label for="gm_notes" class="form-label text-warning">
                            <i class="bi bi-eye-slash"></i> GM Notes <span class="text-warning">(GM Only)</span>
                        </label>
                        <textarea class="form-control border-warning" id="gm_notes" name="gm_notes" rows="8">{{ sess.gm_notes if sess else '' }}</textarea>
                        <div class="form-text text-warning">Never shown to players. Markdown supported.</div>
                    </div>

                </div><!-- card-body -->
            </div><!-- card -->
        </div><!-- col-md-7 -->

    </div><!-- row -->

    <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> {% if sess %}Save Changes{% else %}Create Session{% endif %}
        </button>
        <a href="{% if sess %}{{ url_for('sessions.session_detail', session_id=sess.id) }}{% else %}{{ url_for('sessions.list_sessions') }}{% endif %}"
           class="btn btn-outline-secondary">Cancel</a>
    </div>
</form>
{% if ai_enabled %}
<script>window.SMART_FILL_ENTITY_TYPE = 'session';</script>
<script src="{{ url_for('static', filename='js/smart_fill.js') }}"></script>
<script>
function generatePrepNotes() {
    var btn = document.getElementById('gen-prep-btn');
    var textarea = document.getElementById('prep_notes');

    if (textarea.value.trim() && !confirm('This will replace existing prep notes. Continue?')) {
        return;
    }

    var siteSelect = document.getElementById('adventure_site_id');
    var siteId = siteSelect ? siteSelect.value : '';
    var sessionNumber = document.getElementById('number').value;

    var npcSelect = document.getElementById('npcs_featured');
    var npcNames = [];
    if (npcSelect) {
        for (var i = 0; i < npcSelect.options.length; i++) {
            if (npcSelect.options[i].selected) npcNames.push(npcSelect.options[i].text.trim());
        }
    }

    var questSelect = document.getElementById('quests_touched');
    var questNames = [];
    if (questSelect) {
        for (var i = 0; i < questSelect.options.length; i++) {
            if (questSelect.options[i].selected) questNames.push(questSelect.options[i].text.trim());
        }
    }

    if (!siteId && npcNames.length === 0 && questNames.length === 0) {
        alert('Select an adventure site, NPCs, or quests first to generate prep notes.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generating...';

    fetch('/api/ai/session-prep', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            site_id: siteId || null,
            session_number: sessionNumber || null,
            npc_names: npcNames,
            quest_names: questNames
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generate Prep';
        if (data.error) { alert('Error: ' + data.error); return; }
        if (data.prep_notes) {
            textarea.value = data.prep_notes;
            textarea.scrollTop = 0;
        } else {
            alert('No prep notes generated. Try again.');
        }
    })
    .catch(function() {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars"></i> Generate Prep';
        alert('Failed to generate prep notes. Check your AI provider settings.');
    });
}
</script>
{% endif %}
{% endblock %}
