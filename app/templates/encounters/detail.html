{% extends "base.html" %}
{% block title %}{{ encounter.name }} — The War Table{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('encounters.list_encounters') }}">Encounters</a></li>
        <li class="breadcrumb-item active">{{ encounter.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h2>{{ encounter.name }}</h2>
        <div class="d-flex gap-2 flex-wrap mt-1">
            <span class="badge bg-{{ type_colors.get(encounter.encounter_type, 'secondary') }}">
                {{ encounter.encounter_type | capitalize }}
            </span>
            <span class="badge
                {% if encounter.status == 'planned' %}bg-primary
                {% elif encounter.status == 'used' %}bg-success
                {% else %}bg-secondary{% endif %}">
                {{ encounter.status | capitalize }}
            </span>
            {% if encounter.session %}
            <a href="{{ url_for('sessions.session_detail', session_id=encounter.session.id) }}"
               class="badge bg-secondary text-decoration-none">
                <i class="bi bi-calendar-event me-1"></i>
                {% if encounter.session.number %}#{{ encounter.session.number }} {% endif %}{{ encounter.session.title or 'Untitled' }}
            </a>
            {% endif %}
        </div>
    </div>

    <div class="d-flex gap-2">
        {# Primary action button based on type #}
        {% if encounter.encounter_type == 'combat' %}
        <form method="POST"
              action="{{ url_for('encounters.start_combat', encounter_id=encounter.id) }}">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-shield-shaded me-1"></i> Start Combat
            </button>
        </form>
        {% elif encounter.encounter_type == 'loot' and encounter.loot_table %}
        <a href="{{ url_for('tables.table_detail', table_id=encounter.loot_table.id) }}"
           class="btn btn-success">
            <i class="bi bi-dice-6 me-1"></i> Roll Loot
        </a>
        {% endif %}

        <a href="{{ url_for('encounters.edit_encounter', encounter_id=encounter.id) }}"
           class="btn btn-secondary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <form method="POST"
              action="{{ url_for('encounters.delete_encounter', encounter_id=encounter.id) }}"
              onsubmit="return confirm('Delete encounter \'{{ encounter.name }}\'? This cannot be undone.')">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

{# Creature Roster (combat) #}
{% if encounter.encounter_type == 'combat' %}
<div class="mb-4">
    <h5><i class="bi bi-people me-1"></i>Creature Roster</h5>
    {% if encounter.monsters %}
    <div class="table-responsive">
        <table class="table table-dark table-sm table-borderless align-middle">
            <thead>
                <tr>
                    <th>Creature</th>
                    <th style="width:80px;">Count</th>
                    <th>CR</th>
                    <th>System</th>
                </tr>
            </thead>
            <tbody>
                {% for em in encounter.monsters %}
                <tr>
                    <td>
                        <a href="{{ url_for('bestiary.entry_detail', entry_id=em.bestiary_entry.id) }}"
                           class="text-decoration-none text-light">{{ em.bestiary_entry.name }}</a>
                    </td>
                    <td>× {{ em.count }}</td>
                    <td>{{ em.bestiary_entry.cr_level or '—' }}</td>
                    <td class="text-muted">{{ em.bestiary_entry.system or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted">No creatures added yet. <a href="{{ url_for('encounters.edit_encounter', encounter_id=encounter.id) }}">Edit to add some.</a></p>
    {% endif %}
</div>
{% endif %}

{# Loot table (loot type) #}
{% if encounter.encounter_type == 'loot' and encounter.loot_table %}
<div class="mb-4">
    <h5><i class="bi bi-dice-6 me-1"></i>Loot Table</h5>
    <a href="{{ url_for('tables.table_detail', table_id=encounter.loot_table.id) }}"
       class="btn btn-outline-success">
        <i class="bi bi-dice-6 me-1"></i>{{ encounter.loot_table.name }}
    </a>
</div>
{% endif %}

{# Description #}
{% if encounter.description %}
<div class="mb-4">
    <h5>Description</h5>
    <div>{{ encounter.description | md | safe }}</div>
</div>
{% endif %}

{# GM Notes #}
{% if encounter.gm_notes %}
<div class="mb-4">
    <h5><i class="bi bi-eye-slash me-1 text-warning"></i>GM Notes</h5>
    <div>{{ encounter.gm_notes | md | safe }}</div>
</div>
{% endif %}

{% if not encounter.description and not encounter.gm_notes and not encounter.monsters %}
<p class="text-muted">Nothing here yet. <a href="{{ url_for('encounters.edit_encounter', encounter_id=encounter.id) }}">Add details.</a></p>
{% endif %}

{% endblock %}
