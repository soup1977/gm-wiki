{% extends "base.html" %}
{% block title %}{{ item.name }} â€” The War Table{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        {% if session.get('in_session_mode') %}
        <li class="breadcrumb-item">
            <a href="{{ url_for('session_mode.dashboard') }}">Session Dashboard</a>
        </li>
        {% else %}
        <li class="breadcrumb-item"><a href="{{ url_for('items.list_items') }}">Items</a></li>
        {% endif %}
        <li class="breadcrumb-item active" aria-current="page">{{ item.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h2>{{ item.name }}</h2>
        <p class="text-muted small mb-1">
            Campaign: <a href="{{ url_for('campaigns.campaign_detail', campaign_id=item.campaign.id) }}">{{ item.campaign.name }}</a>
        </p>
        <div class="d-flex gap-2 mt-1">
            {% if item.type %}
                <span class="badge bg-secondary">{{ item.type }}</span>
            {% endif %}
            {% if item.rarity %}
                {% if item.rarity == 'common' %}
                    <span class="badge bg-secondary">{{ item.rarity | title }}</span>
                {% elif item.rarity == 'uncommon' %}
                    <span class="badge bg-success">{{ item.rarity | title }}</span>
                {% elif item.rarity == 'rare' %}
                    <span class="badge bg-primary">{{ item.rarity | title }}</span>
                {% elif item.rarity == 'very rare' %}
                    <span class="badge bg-info text-dark">{{ item.rarity | title }}</span>
                {% elif item.rarity == 'legendary' %}
                    <span class="badge bg-warning text-dark">{{ item.rarity | title }}</span>
                {% elif item.rarity == 'unique' %}
                    <span class="badge bg-danger">{{ item.rarity | title }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ item.rarity | title }}</span>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="d-flex gap-2 align-items-center">
        {% if item.is_player_visible %}
        <a href="{{ url_for('wiki.wiki_item_detail', campaign_id=item.campaign_id, item_id=item.id) }}"
           class="badge bg-success text-decoration-none">
            <i class="bi bi-people"></i> Player Visible
        </a>
        {% else %}
        <span class="badge bg-secondary"><i class="bi bi-eye-slash"></i> Hidden from players</span>
        {% endif %}
        <a href="{{ url_for('items.edit_item', item_id=item.id) }}" class="btn btn-secondary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <form method="POST" action="{{ url_for('items.delete_item', item_id=item.id) }}"
              onsubmit="return confirm('Delete item \'{{ item.name }}\'? This cannot be undone.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
    </div>
</div>

{% if item.tags %}
<div class="mb-3">
    {% for tag in item.tags | sort(attribute='name') %}
    <a href="{{ url_for('items.list_items', tag=tag.name) }}" class="badge bg-secondary text-decoration-none me-1">{{ tag.name }}</a>
    {% endfor %}
</div>
{% endif %}

<div class="row g-4">
    <!-- Main info -->
    <div class="col-md-8">
        {% if item.description %}
        <div class="mb-4">
            <h5 class="text-secondary">Description</h5>
            <div>{{ item.description | md | safe }}</div>
        </div>
        {% endif %}

        {% if item.gm_notes %}
        <div class="mb-4 p-3 border border-warning rounded">
            <h5 class="text-warning"><i class="bi bi-eye-slash"></i> GM Notes</h5>
            <div class="mb-0">{{ item.gm_notes | md | safe }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        {% if item.image_filename %}
        <div class="mb-3">
            <img src="{{ url_for('static', filename='uploads/' + item.image_filename) }}"
                 alt="{{ item.name }}" class="img-fluid rounded"
                 style="max-height: 350px; width: 100%; object-fit: cover;">
        </div>
        {% endif %}

        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header">Owner</div>
            <div class="card-body">
                {% if item.owner_npc %}
                    <a href="{{ url_for('npcs.npc_detail', npc_id=item.owner_npc.id) }}">{{ item.owner_npc.name }}</a>
                {% else %}
                    <span class="text-muted">Party</span>
                {% endif %}
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-header">Origin Location</div>
            <div class="card-body">
                {% if item.origin_location %}
                    <a href="{{ url_for('locations.location_detail', location_id=item.origin_location.id) }}">{{ item.origin_location.name }}</a>
                {% else %}
                    <span class="text-muted">Unknown</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if mentions %}
<div class="mt-4 border-top border-secondary pt-3">
    <h6 class="text-muted small"><i class="bi bi-link-45deg me-1"></i>Referenced by</h6>
    <div class="d-flex flex-wrap gap-2">
        {% for m in mentions %}
        <a href="{{ m.url }}" class="badge bg-secondary text-decoration-none">{{ m.label }}</a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
