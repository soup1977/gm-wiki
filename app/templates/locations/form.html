{% extends "base.html" %}
{% block title %}{{ 'Edit' if location else 'New' }} Location â€” GM Wiki{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('locations.list_locations') }}">Locations</a></li>
                {% if location %}
                <li class="breadcrumb-item"><a href="{{ url_for('locations.location_detail', location_id=location.id) }}">{{ location.name }}</a></li>
                <li class="breadcrumb-item active">Edit</li>
                {% else %}
                <li class="breadcrumb-item active">New</li>
                {% endif %}
            </ol>
        </nav>

        <h2 class="mb-4">{{ 'Edit' if location else 'New' }} Location</h2>

        <form method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name"
                       value="{{ location.name if location else '' }}" required autofocus>
            </div>

            <div class="mb-3">
                <label for="type" class="form-label">Type</label>
                <input type="text" class="form-control" id="type" name="type"
                       value="{{ location.type if location else '' }}"
                       placeholder="e.g. City, Dungeon, Wilderness, Tavern...">
            </div>

            <div class="mb-3">
                <label for="parent_location_id" class="form-label">Parent Location</label>
                <select class="form-select" id="parent_location_id" name="parent_location_id">
                    <option value="">None (top-level)</option>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}"
                            {% if location and location.parent_location_id == loc.id %}selected{% endif %}>
                        {{ loc.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Nest this inside another location (e.g. a district inside a city).</div>
            </div>

            <div class="mb-3">
                <label for="connected_location_ids" class="form-label">Connected Locations</label>
                <select class="form-select" id="connected_location_ids" name="connected_location_ids" multiple size="5">
                    {% for loc in locations %}
                    <option value="{{ loc.id }}"
                            {% if location and loc in location.connected_locations %}selected{% endif %}>
                        {{ loc.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Hold Ctrl (or Cmd on Mac) to select multiple. E.g. a road or passage between locations.</div>
            </div>

            <div class="mb-3">
                <label for="map_image" class="form-label">Map / Scene Image</label>
                {% if location and location.map_filename %}
                <div class="mb-2">
                    <img src="{{ url_for('static', filename='uploads/' + location.map_filename) }}"
                         alt="Current map" class="img-thumbnail" style="max-height: 150px;">
                    <div class="form-text">Upload a new image below to replace this one.</div>
                </div>
                {% endif %}
                <input type="file" class="form-control" id="map_image" name="map_image" accept="image/*">
                <div class="form-text">Accepted formats: JPG, PNG, GIF, WebP. Leave blank to keep the existing image.</div>
            </div>

            <div class="mb-3">
                <label for="tags" class="form-label">Tags</label>
                <input type="text" class="form-control" id="tags" name="tags"
                       value="{{ ', '.join(tag.name for tag in location.tags) if location else '' }}"
                       placeholder="e.g. dungeon, city, hostile">
                <div class="form-text">Comma-separated. Used to filter and group entries.</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4">{{ location.description if location else '' }}</textarea>
                <div class="form-text">Markdown supported.</div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3">{{ location.notes if location else '' }}</textarea>
                <div class="form-text">Markdown supported.</div>
            </div>

            <div class="mb-4">
                <label for="gm_notes" class="form-label">
                    <i class="bi bi-eye-slash"></i> GM Only Notes
                </label>
                <textarea class="form-control border-warning" id="gm_notes" name="gm_notes" rows="3">{{ location.gm_notes if location else '' }}</textarea>
                <div class="form-text text-warning">These notes will never be shown to players. Markdown supported.</div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> {{ 'Save Changes' if location else 'Create Location' }}
                </button>
                {% if location %}
                <a href="{{ url_for('locations.location_detail', location_id=location.id) }}" class="btn btn-outline-secondary">Cancel</a>
                {% else %}
                <a href="{{ url_for('locations.list_locations') }}" class="btn btn-outline-secondary">Cancel</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
