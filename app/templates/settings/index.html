{% extends 'base.html' %}
{% block title %}Settings — The War Table{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-gear"></i> Settings</h2>

<form method="POST" action="{{ url_for('settings.index') }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<div class="row g-4">

    <!-- AI Configuration -->
    <div class="col-md-7">
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <i class="bi bi-cpu"></i> AI Provider
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Choose how AI features (Smart Fill, future NPC chat) connect.
                    Ollama runs locally on your server for free. Anthropic uses the cloud API.
                </p>

                <!-- Provider selector -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Provider</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ai_provider"
                                   id="provNone" value="none"
                                   {{ 'checked' if ai_config.provider == 'none' }}
                                   onchange="toggleProviderSections()">
                            <label class="form-check-label" for="provNone">None</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ai_provider"
                                   id="provOllama" value="ollama"
                                   {{ 'checked' if ai_config.provider == 'ollama' }}
                                   onchange="toggleProviderSections()">
                            <label class="form-check-label" for="provOllama">
                                Ollama <span class="badge bg-success ms-1">Local</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ai_provider"
                                   id="provAnthropic" value="anthropic"
                                   {{ 'checked' if ai_config.provider == 'anthropic' }}
                                   onchange="toggleProviderSections()">
                            <label class="form-check-label" for="provAnthropic">
                                Anthropic <span class="badge bg-secondary ms-1">Cloud</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Ollama settings -->
                <div id="ollama-section" class="border border-secondary rounded p-3 mb-3" style="display:none;">
                    <h6 class="mb-3"><i class="bi bi-hdd-network me-1"></i> Ollama Settings</h6>
                    <div class="mb-2">
                        <label for="ollama_url" class="form-label small">Server URL</label>
                        <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                               id="ollama_url" name="ollama_url"
                               value="{{ ai_config.ollama_url }}"
                               placeholder="http://localhost:11434">
                        <div class="form-text">The URL where your Ollama server is running.</div>
                    </div>
                    <div class="mb-3">
                        <label for="ollama_model" class="form-label small">Model Name</label>
                        <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                               id="ollama_model" name="ollama_model"
                               value="{{ ai_config.ollama_model }}"
                               placeholder="llama3.1">
                        <div class="form-text">The Ollama model to use (e.g. llama3.1, mistral, gemma2).</div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="testConnection('ollama')">
                        <i class="bi bi-wifi"></i> Test Connection
                    </button>
                    <div id="test-ollama-result" class="small mt-2"></div>
                </div>

                <!-- Anthropic settings -->
                <div id="anthropic-section" class="border border-secondary rounded p-3 mb-3" style="display:none;">
                    <h6 class="mb-3"><i class="bi bi-cloud me-1"></i> Anthropic Settings</h6>
                    <div class="mb-3">
                        <label for="anthropic_api_key" class="form-label small">API Key</label>
                        <input type="password" class="form-control form-control-sm bg-dark text-light border-secondary"
                               id="anthropic_api_key" name="anthropic_api_key"
                               value="{{ ai_config.anthropic_api_key }}"
                               placeholder="sk-ant-...">
                        <div class="form-text">
                            Get a key at <a href="https://console.anthropic.com" target="_blank" rel="noopener">console.anthropic.com</a>.
                            Uses claude-haiku-4-5 (fast and affordable).
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="testConnection('anthropic')">
                        <i class="bi bi-wifi"></i> Test Connection
                    </button>
                    <div id="test-anthropic-result" class="small mt-2"></div>
                </div>

                <!-- Image Generation -->
                <div class="border border-secondary rounded p-3 mb-3">
                    <h6 class="mb-3"><i class="bi bi-image me-1"></i> Image Generation</h6>
                    <div class="mb-3">
                        <label for="sd_url" class="form-label small">Stable Diffusion URL</label>
                        <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                               id="sd_url" name="sd_url" value="{{ ai_config.sd_url }}"
                               placeholder="http://localhost:7860">
                        <div class="form-text">AUTOMATIC1111 WebUI with --api flag. Generates NPC portraits, location art, etc.</div>
                    </div>
                    <div class="mb-3">
                        <label for="sd_model" class="form-label small">Model</label>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm bg-dark text-light border-secondary flex-grow-1"
                                    id="sd_model" name="sd_model">
                                {% if ai_config.sd_model %}
                                <option value="{{ ai_config.sd_model }}" selected>{{ ai_config.sd_model }}</option>
                                {% else %}
                                <option value="">— Use active model —</option>
                                {% endif %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSdModels()">
                                <i class="bi bi-arrow-repeat"></i> Load
                            </button>
                        </div>
                        <div class="form-text">Click "Load" to fetch available models from your SD server.</div>
                        <div id="sd-models-result" class="small mt-1"></div>
                    </div>
                    <hr class="border-secondary my-3">
                    <h6 class="mb-3"><i class="bi bi-sliders me-1"></i> Generation Parameters</h6>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label for="sd_sampler" class="form-label small">Sampler</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="sd_sampler" name="sd_sampler"
                                   value="{{ ai_config.sd_sampler or 'DPM++ SDE Karras' }}"
                                   placeholder="DPM++ SDE Karras">
                        </div>
                        <div class="col-3">
                            <label for="sd_steps" class="form-label small">Steps</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="sd_steps" name="sd_steps" min="1" max="100"
                                   value="{{ ai_config.sd_steps or '4' }}">
                        </div>
                        <div class="col-3">
                            <label for="sd_cfg_scale" class="form-label small">CFG Scale</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="sd_cfg_scale" name="sd_cfg_scale" min="1" max="30" step="0.5"
                                   value="{{ ai_config.sd_cfg_scale or '2' }}">
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label for="sd_width" class="form-label small">Width</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="sd_width" name="sd_width" min="256" max="2048" step="64"
                                   value="{{ ai_config.sd_width or '768' }}">
                        </div>
                        <div class="col-6">
                            <label for="sd_height" class="form-label small">Height</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary"
                                   id="sd_height" name="sd_height" min="256" max="2048" step="64"
                                   value="{{ ai_config.sd_height or '1024' }}">
                        </div>
                    </div>
                    <div class="form-text mb-3">
                        Defaults are tuned for SDXL Lightning models (low steps, low CFG).
                        For SD 1.5 models, try Steps: 25, CFG: 7, Sampler: Euler a, Width: 512.
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="testConnection('sd')">
                        <i class="bi bi-wifi"></i> Test Connection
                    </button>
                    <div id="test-sd-result" class="small mt-2"></div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- User Registration + App Stats -->
    <div class="col-md-5">
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <i class="bi bi-people"></i> User Registration
            </div>
            <div class="card-body">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="allow_signup" name="allow_signup"
                           {{ 'checked' if allow_signup }}>
                    <label class="form-check-label" for="allow_signup">Allow new user signups</label>
                </div>
                <div class="form-text mt-2">
                    When enabled, a "Sign up" link appears on the login page. Disable after all players have created accounts.
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Database Stats
            </div>
            <div class="card-body">
                <table class="table table-sm table-dark table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">Campaigns</td>
                            <td class="text-end fw-bold">{{ stats.campaigns }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">NPCs</td>
                            <td class="text-end fw-bold">{{ stats.npcs }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Locations</td>
                            <td class="text-end fw-bold">{{ stats.locations }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Quests</td>
                            <td class="text-end fw-bold">{{ stats.quests }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Sessions</td>
                            <td class="text-end fw-bold">{{ stats.sessions }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Items</td>
                            <td class="text-end fw-bold">{{ stats.item_count }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Bestiary Entries</td>
                            <td class="text-end fw-bold">{{ stats.bestiary }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Compendium Entries</td>
                            <td class="text-end fw-bold">{{ stats.compendium }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
</form>
{% endblock %}

{% block scripts %}
<script>
function toggleProviderSections() {
    const provider = document.querySelector('input[name="ai_provider"]:checked').value;
    document.getElementById('ollama-section').style.display =
        provider === 'ollama' ? 'block' : 'none';
    document.getElementById('anthropic-section').style.display =
        provider === 'anthropic' ? 'block' : 'none';
}

function testConnection(provider) {
    const btn = event.target.closest('button');
    const result = document.getElementById('test-' + provider + '-result');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Testing…';
    result.innerHTML = '';

    fetch('/settings/test-' + provider)
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                result.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> ' + data.message + '</span>';
            } else {
                result.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</span>';
            }
        })
        .catch(() => {
            result.innerHTML = '<span class="text-danger">Request failed.</span>';
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-wifi"></i> Test Connection';
        });
}

function loadSdModels() {
    const btn = event.target.closest('button');
    const result = document.getElementById('sd-models-result');
    const select = document.getElementById('sd_model');
    const currentVal = select.value;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>';
    result.innerHTML = '';

    fetch('/settings/sd-models')
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                select.innerHTML = '<option value="">— Use active model —</option>';
                data.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.title;
                    opt.textContent = m.name;
                    if (m.title === currentVal) opt.selected = true;
                    select.appendChild(opt);
                });
                result.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> ' + data.models.length + ' model(s) loaded</span>';
            } else {
                result.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</span>';
            }
        })
        .catch(() => {
            result.innerHTML = '<span class="text-danger">Request failed.</span>';
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Load';
        });
}

// Auto-detect model type and suggest settings when model changes
const SD_PRESETS = [
    { match: ['lightning', 'turbo', 'lcm'], label: 'Lightning/Turbo',
      steps: 4, cfg: 2, sampler: 'DPM++ SDE Karras' },
    { match: ['xl', 'sdxl', 'pony'], label: 'SDXL',
      steps: 20, cfg: 5, sampler: 'DPM++ 2M Karras' },
    { match: [], label: 'SD 1.5 (default)',
      steps: 25, cfg: 7, sampler: 'Euler a' },
];

function detectModelPreset(modelName) {
    const name = modelName.toLowerCase();
    for (const preset of SD_PRESETS) {
        if (preset.match.length && preset.match.some(kw => name.includes(kw))) {
            return preset;
        }
    }
    // If the name contains 'xl' patterns via dimensions, check width hints
    return SD_PRESETS[SD_PRESETS.length - 1]; // fallback to SD 1.5
}

document.getElementById('sd_model').addEventListener('change', function() {
    const modelName = this.options[this.selectedIndex]?.textContent || this.value;
    if (!modelName || modelName.startsWith('—')) return;

    const preset = detectModelPreset(modelName);
    const isXL = modelName.toLowerCase().includes('xl') ||
                 modelName.toLowerCase().includes('pony');

    document.getElementById('sd_steps').value = preset.steps;
    document.getElementById('sd_cfg_scale').value = preset.cfg;
    document.getElementById('sd_sampler').value = preset.sampler;
    document.getElementById('sd_width').value = isXL ? 768 : 512;
    document.getElementById('sd_height').value = isXL ? 1024 : 768;

    const result = document.getElementById('sd-models-result');
    result.innerHTML = '<span class="text-info"><i class="bi bi-info-circle"></i> ' +
        'Detected <strong>' + preset.label + '</strong> — parameters updated. Review and save.</span>';
});

// Show the right section on page load
toggleProviderSections();
</script>
{% endblock %}
